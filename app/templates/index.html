<!DOCTYPE html>
<html>
  <body>
    <h1>Live streaming</h1>

    <div>
      <video id="videoElement" width="50%" autoplay></video>
    </div>

    <div id="movementStatus"></div>

    <button onclick="startRecording()">Record 5 seconds</button>

    <script>
      var video = document.getElementById("videoElement");
      var recording = false;
      var recordedChunks = [];
      var constraints = { audio: true, video: true };

      function requestCameraAccess() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices
            .getUserMedia(constraints)
            .then(function (mediaStream) {
              var video = document.querySelector("video");
              video.srcObject = mediaStream;
              video.onloadedmetadata = function (e) {
                video.play();
              };
            })
            .catch(function (err) {
              console.log(err.name + ": " + err.message);
            });
        } else {
          console.log("getUserMedia is not supported in this browser.");
          displayBrowserNotSupported();
        }
      }

      function displayBrowserNotSupported() {
        var movementStatus = document.getElementById("movementStatus");
        movementStatus.textContent =
          "Camera access is not supported in this browser. Please switch to a supported browser to use this feature.";
      }

      function enableRecording() {
        var canvas = document.createElement("canvas");
        var context = canvas.getContext("2d");

        function captureFrames() {
          if (recording) {
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            var imageData = context.getImageData(
              0,
              0,
              canvas.width,
              canvas.height
            );

            // Convert image data to base64 string
            var base64Image = canvas.toDataURL("image/png");
            sendImageToBackend(base64Image);
          }

          requestAnimationFrame(captureFrames);
        }

        requestAnimationFrame(captureFrames);
      }

      function startRecording() {
        if (!recording) {
          recordedChunks = [];
          setTimeout(stopRecording, 5000); // Stop recording after 5 seconds
        }
        recording = true;
      }

      function stopRecording() {
        recording = false;
        var blob = new Blob(recordedChunks, { type: "video/webm" });
        var videoURL = URL.createObjectURL(blob);
        downloadVideo(videoURL);
      }

      function sendImageToBackend(imageData) {
        // Send the image data to the backend using AJAX or fetch API
        // Replace the URL with the appropriate endpoint in your backend
        var endpointURL = "http://127.0.0.1:8000/process-image";
        fetch(endpointURL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ image: imageData }),
        })
          .then(function (response) {
            // Handle the response from the backend
            return response.json();
          })
          .then(function (data) {
            // Update the HTML content based on the response
            var movementStatus = document.getElementById("movementStatus");
            if (data.has_movement) {
              movementStatus.textContent = "Movement detected!";
            } else {
              movementStatus.textContent = "No movement detected.";
            }
          })
          .catch(function (error) {
            console.log("Error sending image to backend:", error);
          });
      }

      function downloadVideo(url) {
        var a = document.createElement("a");
        a.href = url;
        a.download = "recorded_video.webm";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Request camera access when the page loads
      requestCameraAccess();
    </script>
  </body>
</html>
