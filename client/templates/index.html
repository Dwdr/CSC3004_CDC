<!DOCTYPE html>
<html>
  <body>
    <h1>Live streaming</h1>

    <div>
      <video id="videoElement" width="50%" autoplay></video>
    </div>
    
    <div id="recordButtonSection">
      <button onclick="startRecording()">Record 5 seconds of Video</button>
    </div>
    
    <div id="violenceStatusSection">
      <h2>Violence Status:</h2>
      <div id="violenceStatus"></div>
    </div>
    

    <script>
      var video = document.getElementById("videoElement");
      var violenceStatus = document.getElementById("violenceStatus");
      var recording = false;
      var recordedChunks = [];
      var mediaRecorder;
      var constraints = { audio: true, video: true };

      function requestCameraAccess() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices
            .getUserMedia(constraints)
            .then(function (mediaStream) {
              video.srcObject = mediaStream;
              video.onloadedmetadata = function (e) {
                video.play();
              };
              enableRecording(); // Start capturing frames once the camera access is granted
            })
            .catch(function (err) {
              console.log(err.name + ": " + err.message);
            });
        } else {
          console.log("getUserMedia is not supported in this browser.");
          displayBrowserNotSupported();
        }
      }

      function displayBrowserNotSupported() {
        var violenceStatus = document.getElementById("violenceStatus");
        violenceStatus.textContent =
          "Camera access is not supported in this browser. Please switch to a supported browser to use this feature.";
      }

      function enableRecording() {
        var canvas = document.createElement("canvas");
        var context = canvas.getContext("2d");

        function captureFrames() {
          if (recording) {
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            var imageData = context.getImageData(
              0,
              0,
              canvas.width,
              canvas.height
            );

            // Convert image data to base64 string
            var base64Image = canvas.toDataURL("image/png");
            sendImageToBackend(base64Image);
          }

          requestAnimationFrame(captureFrames);
        }

        requestAnimationFrame(captureFrames);
      }

      function startRecording() {
        if (!recording) {
          recordedChunks = [];
          mediaRecorder = new MediaRecorder(video.srcObject, {
            mimeType: "video/webm; codecs=vp9",
          });
          mediaRecorder.ondataavailable = handleDataAvailable;
          mediaRecorder.start();
          setTimeout(stopRecording, 5000);
        }
        recording = true;
      }

      function handleDataAvailable(event) {
        if (event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      }

      function stopRecording() {
        if (recording) {
          recording = false;
          mediaRecorder.stop();

          // Wait for the 'stop' event to ensure all data has been processed
          mediaRecorder.addEventListener("stop", function () {
            sendVideoToBackend();
          });
        }
      }

      function sendVideoToBackend() {
      var formData = new FormData();
      recordedChunks.forEach(function (chunk) {
        formData.append("video", chunk, "video.webm");
      });

      fetch("http://127.0.0.1:8001/detect-frame", {
        method: "POST",
        body: formData,
      })
        .then(function (response) {
          return response.json();
        })
        .then(function (data) {
          // Update the HTML content based on the response
          var violenceStatus = document.getElementById("violenceStatus");
          if (data.has_crime) {
            violenceStatus.textContent = "Violence detected!";
          } else {
            violenceStatus.textContent = "No violence detected.";
          }
        })
        .catch(function (error) {
          console.log("Error during crime detection:", error);
        });
    }


    function sendImageToBackend(imageData) {
        // Send the image data to the backend using AJAX or fetch API
        // Replace the URL with the appropriate endpoint in your backend
        var endpointURL = "http://127.0.0.1:8001/process-image";
        fetch(endpointURL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ image: imageData }),
        })
          .then(function (response) {
            // Handle the response from the backend
            return response.json();
          })
          .then(function (data) {
            // Update the HTML content based on the response
            var violenceStatus = document.getElementById("violenceStatus");
            if (data.has_crime) {
              violenceStatus.textContent = "Violence detected!";
            } else {
              violenceStatus.textContent = "No violence detected.";
            }
          })
          .catch(function (error) {
            console.log("Error sending image to backend:", error);
          });
      }
            

      requestCameraAccess();
    </script>
  </body>
</html>
